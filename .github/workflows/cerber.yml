# Generated by Cerber init
name: Cerber CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  cerber-ci:
    name: Cerber CI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build (if script exists)
        run: |
          if npm run | grep -q "build"; then
            npm run build
          else
            echo "No build script defined; skipping"
          fi

      - name: Test (if script exists)
        run: |
          if npm run | grep -q "test"; then
            npm test
          else
            echo "No test script defined; skipping"
          fi

      - name: Run Guardian
        run: |
          if npm run | grep -q "cerber:guardian"; then
            npm run cerber:guardian
          else
            node scripts/cerber-guardian.mjs
          fi

  cerber-postdeploy:
    name: Post-Deploy Health Gate
    runs-on: ubuntu-latest
    needs: []
    env:
      CERBER_HEALTH_URL: ${{ vars.CERBER_HEALTH_URL }}
      CERBER_AUTH_HEADER: ${{ secrets.CERBER_HEALTH_AUTH_HEADER }}
    steps:
      - name: Wait for deployment
        run: sleep 90

      - name: Verify production health
        run: |
          node -e "const wait=90; const url=process.env.CERBER_HEALTH_URL; const auth=process.env.CERBER_AUTH_HEADER; if(!url){console.error('CERBER_HEALTH_URL not set'); process.exit(1);} const opts=auth?{headers:{Authorization:auth}}:{}; (async()=>{await new Promise(r=>setTimeout(r,wait*1000)); const res=await fetch(url,opts); const json=await res.json(); const s=json.summary||{}; const crit=s.criticalIssues||0; const err=s.errorIssues||0; const warn=s.warningIssues||0; console.log('Health summary', s); if(crit>0){console.error('Critical issues detected'); process.exit(1);} if(true && err>0){console.error('Error issues detected'); process.exit(1);} if(false && warn>0){console.error('Warning issues detected'); process.exit(1);} console.log('âœ… Production health check passed');})();"
